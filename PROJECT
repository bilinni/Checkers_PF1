;; The first three lines of this file were inserted by DrRacket. They record metadata
;; about the language level of this file in a form that our tools can easily process.
#reader(lib "htdp-intermediate-lambda-reader.ss" "lang")((modname PROJECT) (read-case-sensitive #t) (teachpacks ()) (htdp-settings #(#t constructor repeating-decimal #f #t none #f () #f)))
; INIT
(require 2htdp/image)
(require 2htdp/universe)

;;SQUARE-SIZE
(define SIZE 50)

;;;WHITE TOKEN
(define W-TOKEN 
   (circle (/ SIZE 2) "solid" "gray"))

;;;BLACK TOKEN
(define B-TOKEN
   (circle (/ SIZE 2) "solid" "red"))

(define B-TOKEN-SUPER
   (overlay (circle (/ SIZE 2) "outline" "gold") B-TOKEN))

(define W-TOKEN-SUPER
   (overlay (circle (/ SIZE 2) "outline" "gold") W-TOKEN))

;;;BOARD-IMAGE


;;BORDER-SQUARE
(define BORDER (square (+(* SIZE 8)(* (* SIZE 8) (/ 1 26.67 )))"solid" "brown"))

;;BOARD 
(define BOARD(above
              (beside (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black"))
              
              (beside (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white"))

              (beside (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black"))
              
              (beside (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white"))

              (beside (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black"))
              
              (beside (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white"))

              (beside (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black"))
              
              (beside (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white")
                      (square SIZE "solid" "black")
                      (square SIZE "solid" "white"))))


;;COMPLETE-BOARD
(define C-BOARD (overlay BOARD BORDER))    

;; Data Type - Token1 and Token2
; A Token1 and a Token2 are Posns

;; Data Type - Maybe<Token1>
; A Maybe<Token1> is one of:
; - a Token1 ; Player 1's token is present
; - #false  ; Player 1's token is missing 
; interpretation: a token from player 1 that may be missing

;; Data Type - Maybe<Token2>
; A Maybe<Token2> is one of:
; - a Token2 ; Player 2's token is present
; - #false  ; Player 2's token is missing 
; interpretation: a token from player 2 that may be missing

;: Data Type - Table
; A Table is a structure (make-Table Image Maybe<Token1> Maybe<Token2>)
;    where          Image          : Image
;                   Present-Token1 : Maybe<Token1>
;                   Present-Token2 : Maybe<Token2>
;
; interpretation: one of the following state:
;                 - a full board of tokens, or a board with at list one token
;                 - a Token1 that may be missing
;                 - a Token2 that may be missing


;State
(define-struct Table [Image Tokens Control Player Win?])

;; Data Type - Token
; A Token is a structure (make-Token color super move1 move2 move3 move4 dead coordinates):
;   - color: is eather the String "White" or "Black"
;   - super: Boolean 
;   - move1: Boolean
;   - move2: Boolean
;   - move3: Boolean
;   - move4: Boolean
;   - dead: Boolean
;   - coordinates: Posn<Number> where Number is a posotive integer number between 0 and 7 (both included)

(define-struct Token [team super coordinates])

(define-struct team [name image])

(define TOKENS-LIST (list
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 1 0))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 3 0))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 5 0))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 7 0))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 0 1))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 2 1))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 4 1))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 6 1))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 1 2))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 3 2))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 5 2))
                        (make-Token (make-team "W" W-TOKEN) #false (make-posn 7 2))

                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 0 5))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 2 5))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 4 5))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 6 5))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 1 6))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 3 6))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 5 6))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 7 6))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 0 7))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 2 7))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 4 7))
                        (make-Token (make-team "B" B-TOKEN) #false (make-posn 6 7))
                        ))


(define-struct Control [Start End])



(define INITIAL-STATE (make-Table
                       BOARD
                       TOKENS-LIST
                       (make-Control #false #false)
                       (make-team "W" W-TOKEN)
                       #false
                       ))

;///////////////////


;DRAWING
(define (draw state)
  (draw-tokens (Table-Image state) (Table-Tokens state)))


(define (draw-tokens Image token-list)
  (cond
    [(null? token-list) Image]
    [else (draw-tokens (overlay/xy (team-image (Token-team (first token-list))) (* -1 (* SIZE (posn-x (Token-coordinates (first token-list)))))
                      (* -1 (* SIZE (posn-y (Token-coordinates (first token-list))))) Image) (rest token-list))])
  )

;///////////


;Mouse movement
(define (handle-mouse state x y event)
  (cond
    [(string=? "button-down" event)
     (make-Table 
      (Table-Image state)
      (Table-Tokens state)
      (make-Control (get-id-by-position (make-posn x y)) (get-id-by-position (make-posn x y)))
      (Table-Player state)
      (Table-Win? state))]
    [(and (string=? "drag" event) (not (false? (Control-Start (Table-Control state)))))
     (make-Table 
      (Table-Image state)
      (Table-Tokens state)
      (make-Control (Control-Start (Table-Control state)) (get-id-by-position (make-posn x y)))
      (Table-Player state)
      (Table-Win? state))]
   
    [(and (string=? "button-up" event) (not (false? (Control-Start (Table-Control state)))))
     (cond
       [(allow-move? state (get-token-by-pos state (Control-Start (Table-Control state)))
                     (get-token-by-pos state (Control-End (Table-Control state)))) (change-position state)]
       [(allow-attack? state (get-token-by-pos state (Control-Start (Table-Control state)))
                     (get-token-by-pos state (Control-End (Table-Control state))))
        (make-Table
         (Table-Image state)
        (remove-element (change-position state) (find-middle (Control-Start (Table-Control state)) (Control-End (Table-Control state))))
        (make-Control (Control-Start (Table-Control state)) (get-id-by-position (make-posn x y)))
        (change-player state)
        (check-win state))]
       [else state])]
    [else state]))














(define (get-id-by-position pos) ; return id of square by position of mouse 
  (make-posn (floor (- (abs (/ (posn-x pos) SIZE)) 0.4)) (floor (- (abs (/ (posn-y pos) SIZE)) 0.4)))) ; Uncalibrated version, to test the rest of the functionality


(define (change-position state) ; delete token from start pos and add it on end pos
  (make-Table
   (Table-Image state)
   (remove-element (make-Table
                 (Table-Image state)
                 (add-element state)
                 (Table-Control state)
                 (Table-Player state)
                 (Table-Win? state)) (Control-Start (Table-Control state)))
   (make-Control #false #false)
   (change-player state)
   (check-win state)))

(define (remove-element state pos) ; state and posn of token we want delete
  (remove #false (map (lambda (item)
         (if (and (= (posn-x (Token-coordinates item)) (posn-x pos))
                  (= (posn-y (Token-coordinates item)) (posn-y pos))) #false item))
         (Table-Tokens state))))

(define (add-element state)
  (if (or (super? (Control-End (Table-Control state)) (Table-Player state))
          (not (false? (Token-super (first (get-token-by-pos state (Control-Start (Table-Control state))))))))
      (append (Table-Tokens state) (list (make-Token
                                          (make-team (team-name (Table-Player state)) (overlay (circle (/ SIZE 2) "outline" "gold") (team-image (Table-Player state))))
                                          #true
                                          (make-posn (posn-x (Control-End (Table-Control state)))
                                                     (posn-y (Control-End (Table-Control state)))))))

      (append (Table-Tokens state) (list (make-Token
                                          (Table-Player state)
                                          #false
                                          (make-posn (posn-x (Control-End (Table-Control state)))
                                                     (posn-y (Control-End (Table-Control state)))))))))
      
  

;/////////////////


;Movement checker

(define (get-token-by-pos state pos) ;Return list<token> or empty list
  (filter (lambda (item)
         (and (= (posn-x (Token-coordinates item)) (posn-x pos))
                  (= (posn-y (Token-coordinates item)) (posn-y pos))))
         (Table-Tokens state))
    )






(define (allow-move? state start-token end-token)    
    (cond
           [(= (length start-token) 0) #false]
           [(not (string=? (team-name (Table-Player state)) (team-name (Token-team (first start-token))))) #false]
           [(not (= (length end-token) 0)) #false]
           [(not (or
                  (and (not (Token-super (first start-token)))
                       (string=? (team-name (Token-team (first start-token))) "W")
                       (= (- (posn-y (Control-End (Table-Control state))) (posn-y (Control-Start (Table-Control state))))  1)
                       (= (abs (- (posn-x (Control-End (Table-Control state))) (posn-x (Control-Start (Table-Control state))))) 1))
                  
                  (and (not (Token-super (first start-token)))
                       (string=? (team-name (Token-team (first start-token))) "B")
                       (= (- (posn-y (Control-End (Table-Control state))) (posn-y (Control-Start (Table-Control state)))) -1)
                       (= (abs (- (posn-x (Control-End (Table-Control state))) (posn-x (Control-Start (Table-Control state))))) 1))
                  
                  (and (Token-super (first start-token))
                       (posn-equal? (posn-abs (posn-subtract (Control-Start (Table-Control state))
                                                             (Control-End (Table-Control state)))) (make-posn 1 1))))) #false]
           [else #true]))



(define (allow-attack? state start-token end-token)    
    (cond
           [(= (length start-token) 0) #false]
           [(= (length (get-token-by-pos state (find-middle (Control-Start (Table-Control state)) (Control-End (Table-Control state))))) 0) #false]
           [(not (string=? (team-name (Table-Player state)) (team-name (Token-team (first start-token))))) #false]
           [(not (= (length end-token) 0)) #false]
           [(not (or
                  (and (not (Token-super (first start-token)))
                       (string=? (team-name (Token-team (first start-token))) "W")
                       (= (- (posn-y (Control-End (Table-Control state))) (posn-y (Control-Start (Table-Control state))))  2)
                       (= (abs (- (posn-x (Control-End (Table-Control state))) (posn-x (Control-Start (Table-Control state))))) 2)
                       (string=? (team-name (Token-team (first (get-token-by-pos state (find-middle (Control-Start (Table-Control state)) (Control-End (Table-Control state)))))))
                                 (invert-team (team-name (Token-team (first start-token))))))
                  
                  (and (not (Token-super (first start-token)))
                       (string=? (team-name (Token-team (first start-token))) "B")
                       (= (- (posn-y (Control-End (Table-Control state))) (posn-y (Control-Start (Table-Control state)))) -2)
                       (= (abs (- (posn-x (Control-End (Table-Control state))) (posn-x (Control-Start (Table-Control state))))) 2)
                       (string=? (team-name (Token-team (first (get-token-by-pos state (find-middle (Control-Start (Table-Control state)) (Control-End (Table-Control state)))))))
                                 (invert-team (team-name (Token-team (first start-token))))))
                  
                  (and (Token-super (first start-token))
                       (posn-equal? (posn-abs (posn-subtract (Control-Start (Table-Control state))
                                                             (Control-End (Table-Control state)))) (make-posn 2 2))
                       (string=? (team-name (Token-team (first (get-token-by-pos state (find-middle (Control-Start (Table-Control state)) (Control-End (Table-Control state)))))))
                                 (invert-team (team-name (Token-team (first start-token)))))))) #false]
           [else #true]))




(define (find-middle start-pos end-pos) ;return posn of middle token 
  (make-posn (+ (posn-x start-pos) (/ (- (posn-x end-pos) (posn-x start-pos)) 2))
             (+ (posn-y start-pos) (/ (- (posn-y end-pos) (posn-y start-pos)) 2))))


(define (posn-subtract pos1 pos2)
  (make-posn (- (posn-x pos1) (posn-x pos2))
             (- (posn-y pos1) (posn-y pos2))))


(define (posn-equal? pos1 pos2)
  (if (and (= (posn-x pos1) (posn-x pos2))
             (= (posn-y pos1) (posn-y pos2))) #true #false))


(define (posn-abs pos)
  (make-posn (abs (posn-x pos)) (abs (posn-y pos))))



(define (change-player state) ; return "B" team if input was "W" team and "W" if it was "B" team
  (cond
    [(string=? (team-name (Table-Player state)) "W") (make-team "B" B-TOKEN)]
    [else (make-team "W" W-TOKEN)]))


(define (invert-team team-name) ; return "B" team if input was "W" team and "W" if it was "B" team
  (cond
    [(string=? team-name "W") "B"]
    [else "W"]))



(define (super? pos team) ;Check if token is super now return boolean
  (if
   (or (and (= (posn-y pos) 7) (string=? (team-name team) "W"))
       (and (= (posn-y pos) 0) (string=? (team-name team) "B"))) #true #false))





(define (check-win state)
  (if (or (= (length (filter (lambda (item)
          (string=? (team-name (Token-team item)) "W"))
         (Table-Tokens state))) 0)
          (= (length (filter (lambda (item)
          (string=? (team-name (Token-team item)) "B"))
         (Table-Tokens state))) 0)) #true #false))


(define (win? state)
  (if (Table-Win? state) #true #false))





;//////////////////



; Main app
(big-bang INITIAL-STATE
  [to-draw draw]
  [on-mouse handle-mouse]
;  [on-key handle-key]
  [stop-when win?]
  )